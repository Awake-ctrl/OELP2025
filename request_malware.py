import requests
import csv

# Make the POST request to the MalwareBazaar API
resp = requests.post("https://mb-api.abuse.ch/api/v1/", data={"query": "get_tags"})

# Check if the response is valid JSON
try:
    data = resp.json()
except ValueError:
    print("Response content is not valid JSON.")
    exit()

# Check if tags are present
if data.get("query_status") == "ok" and "data" in data:
    tags = data["data"]

    # Write to CSV
    with open("malware_tags.csv", mode="w", newline="", encoding="utf-8") as csv_file:
        writer = csv.DictWriter(csv_file, fieldnames=["tag", "tag_count", "tag_category"])
        writer.writeheader()

        for tag_entry in tags:
            writer.writerow({
                "tag": tag_entry.get("tag"),
                "tag_count": tag_entry.get("tag_count"),
                "tag_category": tag_entry.get("tag_category")
            })

    print("Tags saved to malware_tags.csv.")
else:
    print("Failed to retrieve tags:", data.get("query_status", "Unknown error"))
